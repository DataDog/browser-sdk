variables:
  CURRENT_STAGING: staging-20
  APP: 'browser-sdk'
  CURRENT_CI_IMAGE: 79
  BUILD_STABLE_REGISTRY: 'registry.ddbuild.io'
  CI_IMAGE: '$BUILD_STABLE_REGISTRY/ci/$APP:$CURRENT_CI_IMAGE'
  GIT_REPOSITORY: 'git@github.com:DataDog/browser-sdk.git'
  MAIN_BRANCH: 'main'
  NEXT_MAJOR_BRANCH: ''
  CHROME_PACKAGE_VERSION: 135.0.7049.52-1
  FF_TIMESTAMPS: 'true' # Enable timestamps for gitlab-ci logs

cache:
  key:
    files:
      - yarn.lock
  paths:
    - .yarn/cache

stages:
  - task
  - ci-image
  - test
  - after-tests
  - deploy

.base-configuration:
  tags:
    - 'arch:amd64'
  image: $CI_IMAGE
  retry:
    max: 2
    when:
      - runner_system_failure

########################################################################################################################
# Branch selection helpers
########################################################################################################################

.test-allowed-branches:
  except:
    refs:
      - /^release\//
      - schedules

.bs-allowed-branches:
  except:
    refs:
      - main
      - /^mq-working-branch-staging-[0-9]+-[a-z0-9]+$/
      - /^staging-[0-9]+$/
      - /^release\//
      - schedules

.feature-branches:
  except:
    refs:
      - main
      - tags
      - /^staging-[0-9]+$/
      - /^release\//
      - schedules
    variables:
      - $CI_COMMIT_REF_NAME == $NEXT_MAJOR_BRANCH

.next-major-branch:
  only:
    variables:
      - $CI_COMMIT_REF_NAME == $NEXT_MAJOR_BRANCH

.staging:
  only:
    variables:
      - $CI_COMMIT_REF_NAME == $CURRENT_STAGING

.main:
  only:
    refs:
      - main
  except:
    refs:
      - schedules
    variables:
      - $CI_COMMIT_TITLE =~ /^v[0-9.]+/

.tags:
  only:
    refs:
      - tags

###########################################################################################################################
# Resource allocation
###########################################################################################################################
.resource-allocation-4-cpus:
  variables:
    WORKERS: 2
    KUBERNETES_CPU_REQUEST: 4
    KUBERNETES_CPU_LIMIT: 4
    KUBERNETES_MEMORY_REQUEST: 16Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
    NODE_OPTIONS: '--max-old-space-size=16000'

########################################################################################################################
# CI image
########################################################################################################################

ci-image:
  stage: ci-image
  extends:
    - .base-configuration
    - .feature-branches
  when: manual
  tags: ['runner:docker', 'size:large']
  image: $BUILD_STABLE_REGISTRY/docker:18.03.1
  script:
    - docker build --build-arg CHROME_PACKAGE_VERSION=$CHROME_PACKAGE_VERSION --tag $CI_IMAGE .
    - docker push $CI_IMAGE

########################################################################################################################
# Tests
########################################################################################################################

build-and-lint:
  extends:
    - .base-configuration
    - .test-allowed-branches
  interruptible: true
  script:
    - yarn
    - yarn build
    - yarn lint
    - node scripts/check-packages.js

########################################################################################################################
# Deploy
########################################################################################################################

deploy-manual:
  stage: deploy
  extends:
    - .test-allowed-branches
  trigger:
    include:
      - local: .gitlab/deploy-manual.yml

deploy-auto:
  stage: deploy
  extends:
    - .test-allowed-branches
  trigger:
    include:
      - local: .gitlab/deploy-auto.yml

# A noop job that's used to signal to `to-staging` that it can merge to the
# staging branch, even though the pipeline is still running
tests-passed:
  stage: after-tests
  extends:
    - .base-configuration
    - .feature-branches
  interruptible: true
  script:
    - 'true'
