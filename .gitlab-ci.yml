variables:
  CURRENT_STAGING: staging-53
  APP: 'browser-sdk'
  CURRENT_CI_IMAGE: 75
  BUILD_STABLE_REGISTRY: 'registry.ddbuild.io'
  CI_IMAGE: '$BUILD_STABLE_REGISTRY/ci/$APP:$CURRENT_CI_IMAGE'
  GIT_REPOSITORY: 'git@github.com:DataDog/browser-sdk.git'
  MAIN_BRANCH: 'main'
  NEXT_MAJOR_BRANCH: 'v6'
  CHROME_PACKAGE_VERSION: 131.0.6778.69-1

cache:
  key:
    files:
      - yarn.lock
  paths:
    - .yarn/cache

stages:
  - task
  - ci-image
  - test
  - after-tests
  - browserstack
  - pre-deploy
  - deploy:canary
  - notify:canary
  - deploy
  - notify

.base-configuration:
  tags:
    - 'arch:amd64'
  image: $CI_IMAGE
  retry:
    max: 2
    when:
      - runner_system_failure

########################################################################################################################
# Branch selection helpers
########################################################################################################################

.test-allowed-branches:
  except:
    refs:
      - /^release\//
      - schedules

.bs-allowed-branches:
  except:
    refs:
      - main
      - /^mq-working-branch-staging-[0-9]+-[a-z0-9]+$/
      - /^staging-[0-9]+$/
      - /^release\//
      - schedules

.feature-branches:
  except:
    refs:
      - main
      - tags
      - /^staging-[0-9]+$/
      - /^release\//
      - schedules

.staging:
  only:
    variables:
      - $CI_COMMIT_REF_NAME == $CURRENT_STAGING

.main:
  only:
    refs:
      - main
  except:
    refs:
      - schedules
    variables:
      - $CI_COMMIT_TITLE =~ /^v[0-9.]+/

.tags:
  only:
    refs:
      - tags

###########################################################################################################################
# Resource allocation
###########################################################################################################################

.resource-allocation-4-cpus:
  variables:
    WORKERS: 2
    KUBERNETES_CPU_REQUEST: 4
    KUBERNETES_CPU_LIMIT: 4
    KUBERNETES_MEMORY_REQUEST: 16Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
    NODE_OPTIONS: '--max-old-space-size=16000'

########################################################################################################################
# Tests
########################################################################################################################

e2e:
  extends:
    - .base-configuration
    - .test-allowed-branches
  interruptible: true
  artifacts:
    when: always
    paths: ['test-report/e2e/specs.log']
    reports:
      junit: test-report/e2e/*.xml
  script:
    - yarn
    - FORCE_COLOR=1 yarn test:e2e
  after_script:
    - node ./scripts/test/export-test-result.js e2e
