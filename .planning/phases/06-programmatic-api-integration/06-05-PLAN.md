---
phase: 06-programmatic-api-integration
plan: 05
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - scripts/build/lib/bundleGenerator.ts
  - scripts/build/lib/bundleGenerator.README.md
autonomous: true

must_haves:
  truths:
    - "Developers understand how to use generateBundle() API"
    - "Build tool integration examples provided for webpack, Vite, Node.js"
    - "API types are well-documented with JSDoc comments"
    - "Error scenarios and their solutions are documented"
  artifacts:
    - path: "scripts/build/lib/bundleGenerator.README.md"
      provides: "API documentation and usage examples"
      must_contain: "generateBundle\|API\|webpack\|vite\|Node.js"
    - path: "scripts/build/lib/bundleGenerator.ts"
      provides: "JSDoc comments on exported functions"
      must_contain: "@param\|@returns\|@example"
  key_links:
    - from: "README.md"
      to: "generateBundle() function"
      via: "usage examples and API reference"
      pattern: "import.*generateBundle\|await generateBundle"

---

## Objective

Create comprehensive documentation for the programmatic API including README.md for the generator library, JSDoc comments on exported functions, and build tool integration examples. Documentation enables developers to discover and use the API correctly.

**Purpose:** Good documentation reduces friction for build tool integration. Examples show how to integrate with different build systems.

**Output:**

- `bundleGenerator.README.md` with API reference and examples
- JSDoc comments on all exported functions and types
- Build tool integration guides (webpack, Vite, raw Node.js)
- Error scenarios and troubleshooting

---

## Execution Context

@/Users/adrian.delarosa/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adrian.delarosa/.claude/get-shit-done/templates/summary.md

## Context

@.planning/phases/06-programmatic-api-integration/06-RESEARCH.md (Section 8: Documentation & Examples)
@scripts/build/lib/bundleGenerator.ts

---

## Tasks

<task type="auto">
  <name>Task 1: Add JSDoc comments to bundleGenerator.ts exports</name>
  <files>scripts/build/lib/bundleGenerator.ts</files>
  <action>
    Add comprehensive JSDoc comments to all exported functions, types, and interfaces in bundleGenerator.ts. JSDoc provides IDE autocomplete and documentation to developers using the API.

    **JSDoc comments to add:**

    1. **On `generateBundle()` function:**
       ```typescript
       /**
        * Generate a browser-ready bundle combining SDK and embedded remote configuration.
        *
        * Downloads the Datadog Browser SDK and fetches remote configuration from Datadog,
        * then combines them into a single JavaScript file that can be embedded in your app.
        * The generated bundle is a standalone IIFE that initializes the SDK with the
        * embedded configuration without requiring any additional network requests.
        *
        * @param options - Configuration options for bundle generation
        * @returns Promise resolving to the generated JavaScript bundle as a string
        * @throws Error if configuration validation fails or network requests fail
        *
        * @example
        * import { generateBundle } from './bundleGenerator'
        *
        * const bundle = await generateBundle({
        *   applicationId: 'your-app-id',
        *   remoteConfigurationId: 'your-config-id',
        *   variant: 'rum'
        * })
        *
        * // Write to file or inline into HTML
        * await writeFile('./datadog-bundle.js', bundle)
        */
       ```

    2. **On `GenerateBundleOptions` interface:**
       ```typescript
       /**
        * Options for generateBundle() function.
        *
        * @property applicationId - Datadog application ID (required). Get this from Datadog UI > RUM > Settings
        * @property remoteConfigurationId - Remote configuration ID (required). Get this from Datadog UI > Remote Configuration
        * @property variant - SDK variant to use: 'rum' for full SDK, 'rum-slim' for lightweight version (required)
        * @property site - Datadog site (optional, default: 'datadoghq.com'). Use 'datadoghq.eu' for EU region
        * @property datacenter - Datacenter for SDK download (optional, default: 'us1'). Use for region-specific CDN
        */
       ```

    3. **On `SdkVariant` type:**
       ```typescript
       /**
        * Supported SDK variants.
        *
        * - 'rum': Full SDK with all features (RUM, session replay, profiling)
        * - 'rum-slim': Lightweight SDK with core RUM features only
        */
       ```

    4. **On `fetchConfig()` function:**
       ```typescript
       /**
        * Fetch remote configuration from Datadog.
        *
        * Retrieves the remote configuration for the specified application and configuration ID.
        * Configuration includes RUM settings, feature flags, and dynamic values.
        *
        * @param options - Fetch options (applicationId, remoteConfigurationId, optional site)
        * @returns Promise resolving to remote configuration result
        * @throws Error if configuration cannot be fetched or is invalid
        *
        * @internal - Internal API, use generateBundle() instead for end-to-end workflow
        */
       ```

    5. **On `downloadSDK()` function:**
       ```typescript
       /**
        * Download pre-built SDK from Datadog CDN.
        *
        * Downloads the minified SDK bundle for the specified variant.
        * Includes automatic caching to avoid re-fetching the same variant.
        *
        * @param options - Download options (variant, optional datacenter)
        * @returns Promise resolving to SDK JavaScript code as string
        * @throws Error if download fails (network error, 404, timeout, etc.)
        *
        * @internal - Internal API, use generateBundle() instead for end-to-end workflow
        */
       ```

    6. **On `generateCombinedBundle()` function:**
       ```typescript
       /**
        * Generate combined bundle from SDK code and configuration.
        *
        * Creates a single JavaScript file (IIFE) that:
        * 1. Defines the embedded remote configuration
        * 2. Includes the SDK code
        * 3. Auto-initializes SDK with embedded configuration
        *
        * @param options - Bundle generation options (sdkCode, config, variant)
        * @returns Generated JavaScript bundle as string
        *
        * @internal - Internal API, use generateBundle() instead for end-to-end workflow
        */
       ```

    **JSDoc best practices:**
    - Use @param for each parameter with type and description
    - Use @returns for return value with type and description
    - Use @throws for exceptions
    - Use @example for real-world usage examples
    - Use @internal for private/internal APIs
    - Use descriptive parameter names that match code
    - Include links to Datadog docs for IDs (applicationId, configId)
    - Explain what each variant is best for (rum vs rum-slim)

    **Implementation approach:**
    - Add JSDoc immediately before each export
    - Keep comments concise but complete (2-5 lines for simple exports)
    - Include examples for main public API (generateBundle)
    - Mark internal functions with @internal
    - Ensure types match actual implementation

  </action>
  <verify>
    - All exported functions have JSDoc comments
    - All exported interfaces have JSDoc comments
    - `GenerateBundleOptions` documented with @property for each field
    - `generateBundle()` includes @example showing real usage
    - `SdkVariant` type documented with variant descriptions
    - Internal functions marked with @internal
    - JSDoc syntax is valid (can be parsed by IDEs)
    - `yarn typecheck` still passes
  </verify>
  <done>
    - JSDoc comments added to all exports
    - Main API (generateBundle) has detailed documentation
    - Types documented with property descriptions
    - Examples provided for key functions
    - IDE autocomplete will show documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bundleGenerator.README.md with API reference and build tool examples</name>
  <files>scripts/build/lib/bundleGenerator.README.md</files>
  <action>
    Create comprehensive README.md for the generator library. This is the primary documentation developers will reference when integrating the API.

    **README.md structure and content:**

    ```markdown
    # Datadog Browser SDK Bundle Generator API

    Generate pre-configured Datadog Browser SDK bundles with embedded remote configuration for zero-request SDK initialization.

    ## Quick Start

    ```typescript
    import { generateBundle } from './bundleGenerator'
    import { writeFile } from 'node:fs/promises'

    const bundle = await generateBundle({
      applicationId: 'your-app-id',
      remoteConfigurationId: 'your-config-id',
      variant: 'rum'
    })

    await writeFile('./datadog-bundle.js', bundle)
    ```

    ## API Reference

    ### generateBundle(options)

    Generate a browser-ready bundle combining SDK and embedded remote configuration.

    **Parameters:**
    | Parameter | Type | Required | Description |
    |-----------|------|----------|-------------|
    | applicationId | string | Yes | Datadog application ID |
    | remoteConfigurationId | string | Yes | Remote configuration ID |
    | variant | 'rum' \| 'rum-slim' | Yes | SDK variant (full or lightweight) |
    | site | string | No | Datadog site (default: 'datadoghq.com', use 'datadoghq.eu' for EU) |
    | datacenter | string | No | CDN datacenter (default: 'us1') |

    **Returns:** Promise<string> - Generated JavaScript bundle

    **Errors:**
    | Error | Cause | Solution |
    |-------|-------|----------|
    | applicationId is required | Missing required parameter | Provide your Datadog application ID from RUM > Settings |
    | Invalid variant | variant is not 'rum' or 'rum-slim' | Use one of the two supported variants |
    | Failed to fetch remote configuration | Config ID invalid or doesn't exist | Verify remoteConfigurationId in Datadog UI > Remote Configuration |
    | SDK bundle not found | Invalid variant or SDK version | Check variant spelling and ensure SDK version is available |

    ## Build Tool Integration Examples

    ### Raw Node.js (Recommended for most use cases)

    The simplest integration: run a Node.js script before your main build.

    ```typescript
    // scripts/generate-datadog-bundle.ts
    import { generateBundle } from '../path/to/bundleGenerator'
    import { writeFile } from 'node:fs/promises'

    const bundle = await generateBundle({
      applicationId: process.env.DATADOG_APP_ID!,
      remoteConfigurationId: process.env.DATADOG_CONFIG_ID!,
      variant: 'rum'
    })

    await writeFile('./public/datadog-rum.js', bundle)
    console.log('âœ“ Datadog bundle generated')
    ```

    Add to package.json:
    ```json
    {
      "scripts": {
        "prebuild": "tsx scripts/generate-datadog-bundle.ts",
        "build": "webpack"
      }
    }
    ```

    Include in HTML:
    ```html
    <script src="/datadog-rum.js"></script>
    ```

    ### Webpack Plugin

    Integrate generator into webpack build pipeline.

    ```typescript
    // webpack-plugin.ts
    import { generateBundle, GenerateBundleOptions } from '../path/to/bundleGenerator'

    class DatadogBundlePlugin {
      constructor(private options: GenerateBundleOptions) {}

      apply(compiler) {
        compiler.hooks.emit.tapPromise('DatadogBundlePlugin', async (compilation) => {
          const bundle = await generateBundle(this.options)
          compilation.assets['datadog-rum-bundle.js'] = {
            source: () => bundle,
            size: () => bundle.length,
          }
        })
      }
    }

    // webpack.config.js
    module.exports = {
      plugins: [
        new DatadogBundlePlugin({
          applicationId: process.env.DATADOG_APP_ID,
          remoteConfigurationId: process.env.DATADOG_CONFIG_ID,
          variant: 'rum'
        })
      ]
    }
    ```

    ### Vite Integration

    Integrate generator into Vite build hooks.

    ```typescript
    // vite.config.ts
    import { defineConfig } from 'vite'
    import { generateBundle } from '../path/to/bundleGenerator'
    import { writeFile } from 'node:fs/promises'

    export default defineConfig({
      plugins: [
        {
          name: 'datadog-bundle',
          async buildStart() {
            const bundle = await generateBundle({
              applicationId: process.env.DATADOG_APP_ID!,
              remoteConfigurationId: process.env.DATADOG_CONFIG_ID!,
              variant: 'rum'
            })
            await writeFile('./public/datadog-rum.js', bundle)
          }
        }
      ]
    })
    ```

    ## Configuration

    ### Getting Your IDs

    **Application ID:**
    1. Go to Datadog UI > Real User Monitoring > Settings
    2. Copy the Application ID

    **Configuration ID:**
    1. Go to Datadog UI > Remote Configuration
    2. Create or select a configuration
    3. Copy the Configuration ID

    ### Variants

    **rum** - Full SDK (~100KB minified)
    - Includes RUM collection, session replay, profiling
    - Use for comprehensive monitoring

    **rum-slim** - Lightweight SDK (~50KB minified)
    - Core RUM collection only
    - Use for performance-critical applications

    ## Performance

    ### Caching

    SDK downloads are cached in-memory within a Node.js process. Repeated calls with the same variant are served from cache (<5ms instead of ~500ms network request).

    ```typescript
    // First call: downloads from CDN (~500ms)
    const bundle1 = await generateBundle({ ... })

    // Second call: returns from cache (<5ms)
    const bundle2 = await generateBundle({ ... })
    ```

    Cache is automatically cleared when Node.js process exits.

    ### Bundle Size

    Generated bundles are typically 130-150KB minified:
    - SDK code: 100-110KB
    - Remote configuration: 5-20KB
    - Wrapper code: <1KB

    ## Error Handling

    All errors from generateBundle() include actionable messages:

    ```typescript
    try {
      const bundle = await generateBundle({
        applicationId: 'invalid',
        remoteConfigurationId: 'cfg-id',
        variant: 'rum'
      })
    } catch (error) {
      // Error: applicationId is required and must be a non-empty string.
      // Get this from Datadog UI > RUM > Settings
      console.error(error.message)
    }
    ```

    ## Dynamic Configuration Values

    Remote configuration can include dynamic values that are resolved at browser runtime:

    - **Cookies:** Extract values from document.cookie
    - **DOM:** Extract values from page HTML
    - **JavaScript:** Access values from window object

    These dynamic values are embedded as-is in the generated bundle. The SDK resolves them at runtime when it initializes.

    Example:
    ```javascript
    // Config in bundle includes:
    {
      "user": {
        "id": {
          "rcSerializedType": "dynamic",
          "strategy": "cookie",
          "name": "user_id"
        }
      }
    }

    // At runtime in browser:
    // SDK reads document.cookie and extracts user_id value
    // Sets config.user.id to the cookie value
    ```

    ## Development

    ### Testing

    ```bash
    # Unit tests
    yarn test:unit --spec scripts/build/lib/bundleGenerator.spec.ts

    # E2E tests (verify SDK actually works with embedded config)
    yarn test:e2e -g "embedded-config"
    ```

    ### Building

    ```bash
    yarn build
    ```

    ## Troubleshooting

    **SDK doesn't load on page**
    - Check script tag is loading (check network tab in DevTools)
    - Verify bundle is valid JavaScript (open in DevTools console)
    - Check browser console for SDK initialization errors

    **Configuration not being used**
    - Verify bundles is loaded before page initialization
    - Check that embedded config in bundle matches your settings
    - Verify DD_RUM is available globally after bundle loads

    **Network request to config endpoint still happening**
    - This indicates SDK is not using embedded config
    - Verify bundle was generated with your config ID
    - Check that bundle is being loaded (not a fallback SDK)

    ## Related Resources

    - [Datadog RUM Docs](https://docs.datadoghq.com/real_user_monitoring/)
    - [Remote Configuration Docs](https://docs.datadoghq.com/real_user_monitoring/guide/remote-configuration/)
    - [SDK GitHub](https://github.com/DataDog/browser-sdk)
    ```

    **Key sections to include:**
    1. Quick Start (3 lines of code)
    2. API Reference (parameters, return, errors)
    3. Build tool examples (Node.js, webpack, Vite)
    4. Configuration (how to get IDs)
    5. Variants explanation
    6. Performance notes (caching, bundle size)
    7. Error handling guidance
    8. Dynamic values explanation
    9. Testing instructions
    10. Troubleshooting guide

    **Implementation approach:**
    - Create new file at `scripts/build/lib/bundleGenerator.README.md`
    - Keep examples short and copy-paste ready
    - Include environment variable patterns
    - Provide error scenarios and solutions
    - Link to Datadog docs for additional info

  </action>
  <verify>
    - README.md file created at scripts/build/lib/bundleGenerator.README.md
    - Quick start example works as shown
    - API reference table is complete
    - All 3 build tool examples (Node.js, webpack, Vite) are included
    - Error scenarios documented with solutions
    - Configuration instructions are clear
    - Performance section explains caching
    - Troubleshooting guide covers common issues
    - File is valid Markdown (can be rendered)
  </verify>
  <done>
    - README.md created with comprehensive API documentation
    - Quick start and API reference provided
    - Build tool integration examples (3 examples)
    - Configuration and error handling documented
    - Performance and caching explained
    - Troubleshooting guide included
  </done>
</task>

</tasks>

---

## Verification

After completing both tasks:

1. **JSDoc comments:** All exported functions and types documented
2. **IDE support:** Autocomplete shows documentation
3. **README.md:** Comprehensive guide with examples
4. **Build tool examples:** Node.js, webpack, and Vite covered
5. **Error scenarios:** Common errors and solutions documented
6. **No regressions:** Compilation still succeeds

---

## Success Criteria

- [x] JSDoc comments added to all exports
- [x] generateBundle() has usage example
- [x] All parameters documented with @param
- [x] bundleGenerator.README.md created
- [x] Quick start example included
- [x] API reference complete
- [x] 3+ build tool integration examples
- [x] Error scenarios and solutions documented
- [x] Configuration instructions clear
- [x] Performance notes included

---

## Notes

**Plan relationship:** Plan 05 depends on Plans 01 and 02 (API and caching must exist before documentation). Runs in Wave 3 after verification of implementation.

**Documentation is code:** Keep JSDoc comments and README.md in sync. If API changes, update docs immediately.

---

## Output

After completion, create `.planning/phases/06-programmatic-api-integration/06-05-SUMMARY.md` with:

- JSDoc comments summary
- README.md sections
- Build tool examples covered
- Files created/modified
- Commits made
