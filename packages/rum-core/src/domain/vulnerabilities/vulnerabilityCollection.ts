import type { Vulnerability, VulnerabilityType  } from '@datadog/browser-core';
import { Observable, clocksNow   } from '@datadog/browser-core';
import type { LifeCycle} from '../lifeCycle';
import { LifeCycleEventType} from '../lifeCycle';
import type { CustomAction } from '../action/actionCollection';
import type { CommonContext } from '../contexts/commonContext';
import { ActionType } from '../../rawRumEvent.types';
import { trackAutocomplete } from './trackAutocomplete';
import { trackSri } from './trackSri';

// vulnerability deduplication map. Is there some element identifier we could use instead HTMLElement?
const reportedMap = new WeakMap<HTMLElement, Set<VulnerabilityType>>()

export function startVulnerabilityCollection(
  lifeCycle: LifeCycle,
  addAction: (action: CustomAction, savedCommonContext?: CommonContext | undefined) => void,
  getCommonContext: () => CommonContext
) {
  const vulnerabilityObservable = new Observable<Vulnerability>()

  trackAutocomplete(lifeCycle, vulnerabilityObservable)
  trackSri(lifeCycle, vulnerabilityObservable)

  vulnerabilityObservable.subscribe((vulnerability) => lifeCycle.notify(LifeCycleEventType.VULNERABILITY_COLLECTED, { vulnerability }))

  return doStartVulnerabilityCollection(lifeCycle, addAction, getCommonContext)
}

export function doStartVulnerabilityCollection(
  lifeCycle: LifeCycle,
  addAction: (action: CustomAction, savedCommonContext?: CommonContext | undefined) => void,
  getCommonContext: () => CommonContext
) {
  lifeCycle.subscribe(LifeCycleEventType.VULNERABILITY_COLLECTED, ({ vulnerability }) => {
    if (!reported(vulnerability)) {
      const vulnerabilityContext = getVulnerabilityContext(vulnerability, getCommonContext)
      addAction({
        type: ActionType.CUSTOM,
        name: 'vulnerability',
        startClocks: clocksNow(),
      }, vulnerabilityContext)
    }
  })
}

function reported(vulnerability: Vulnerability) {
  const { element, type } = vulnerability

  let reportedVulnTypes = reportedMap.get(element)  
  if (reportedVulnTypes === undefined) {
    reportedVulnTypes = new Set<VulnerabilityType>()
    reportedMap.set(element, reportedVulnTypes)
  } else if (reportedVulnTypes.has(type)) {
    return true
  }

  reportedVulnTypes.add(type)

  return false
}

function getVulnerabilityContext(
  vulnerability: Vulnerability,
  getCommonContext: () => CommonContext
): CommonContext {
  const vulnerabilityContext = getCommonContext()

  const { type, element, location } = vulnerability
  const evidence = getEvidence(element)

  vulnerabilityContext.context = {
    type,
    evidence,
    location: location.href,
  }

  return vulnerabilityContext
}

function getEvidence(element: HTMLElement): string {
  const attributes = Array.from(element.attributes)
    .map(attr => `${attr.name}="${attr.value}"`)
    .join(' ')

  return `<${element.nodeName.toLowerCase()} ${attributes}>`
}