stages:
  - pre-notify
  - deploy
  - post-notify

.base-configuration:
  tags:
    - 'arch:amd64'
  image: $CI_IMAGE
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts

.deploy-prod:
  stage: deploy
  script:
    - export BUILD_MODE=release
    - VERSION=$(node -p -e "require('./lerna.json').version")
    - yarn
    - yarn build:bundle
    - node ./scripts/deploy/deploy-prod-dc.ts v${VERSION%%.*} $DATACENTER --check-telemetry-errors

step-1_deploy-prod-minor-dcs:
  when: manual
  allow_failure: false
  extends:
    - .base-configuration
    - .deploy-prod
  variables:
    DATACENTER: minor-dcs

step-2_deploy-prod-private-regions:
  needs:
    - step-1_deploy-prod-minor-dcs
  extends:
    - .base-configuration
    - .deploy-prod
  variables:
    DATACENTER: private-regions

step-3_deploy-prod-eu1:
  needs:
    - step-2_deploy-prod-private-regions
  extends:
    - .base-configuration
    - .deploy-prod
  variables:
    DATACENTER: eu1

step-4_deploy-prod-us1:
  needs:
    - step-3_deploy-prod-eu1
  extends:
    - .base-configuration
    - .deploy-prod
  variables:
    DATACENTER: us1

step-5_deploy-prod-gov:
  needs:
    - step-4_deploy-prod-us1
  extends:
    - .base-configuration
    - .deploy-prod
  variables:
    DATACENTER: gov

step-6_publish-npm:
  needs:
    - step-5_deploy-prod-gov
  stage: deploy
  extends:
    - .base-configuration
  allow_failure: false
  script:
    - yarn
    - node ./scripts/deploy/publish-npm.ts

step-7_publish-developer-extension:
  needs:
    - step-6_publish-npm
  stage: deploy
  extends:
    - .base-configuration
  allow_failure: false
  script:
    - yarn
    - node ./scripts/deploy/publish-developer-extension.ts

step-8_create-github-release:
  needs:
    - step-7_publish-developer-extension
  stage: deploy
  extends:
    - .base-configuration
  allow_failure: false
  script:
    - yarn
    - node scripts/release/create-github-release.ts

########################################################################################################################
# Notify
########################################################################################################################

include: 'https://gitlab-templates.ddbuild.io/slack-notifier/v1/template.yml'

.prepare_notification:
  extends: .slack-notifier-base
  before_script:
    - COMMIT_MESSAGE=`git show-branch --no-name HEAD`
    - BUILD_URL="$CI_PROJECT_URL/pipelines/$CI_PIPELINE_ID"
    - COMMIT_URL="$CI_PROJECT_URL/commits/$CI_COMMIT_SHA"

notify-deploy-ready:
  stage: pre-notify
  extends:
    - .prepare_notification
  script:
    - 'MESSAGE_TEXT=":i: $CI_PROJECT_NAME <$BUILD_URL|$COMMIT_MESSAGE> ready to be deployed *automatically* to :datadog:"'
    - postmessage "#browser-sdk-deploy" "$MESSAGE_TEXT"

notify-deploy-success:
  stage: post-notify
  needs:
    - step-8_create-github-release
  extends:
    - .prepare_notification
  script:
    - 'MESSAGE_TEXT=":rocket: $CI_PROJECT_NAME <$COMMIT_URL|$COMMIT_MESSAGE> *automatically* deployed to :earth_americas:."'
    - postmessage "#browser-sdk-deploy" "$MESSAGE_TEXT"
    - postmessage "#rum-browser-sdk-ops" "$MESSAGE_TEXT"

notify-deploy-failure:
  stage: post-notify
  extends:
    - .prepare_notification
  when: on_failure
  script:
    - 'MESSAGE_TEXT=":host-red: $CI_PROJECT_NAME *automatic* deployment of <$BUILD_URL|$COMMIT_MESSAGE> failed."'
    - postmessage "#browser-sdk-deploy" "$MESSAGE_TEXT"
