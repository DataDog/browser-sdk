<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Debugger Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #632ca6;
        margin-top: 0;
      }
      .section {
        margin: 20px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 4px;
        border-left: 4px solid #632ca6;
      }
      .section h2 {
        margin-top: 0;
        color: #333;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      button {
        background: #632ca6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }
      button:hover {
        background: #4a1f7a;
      }
      .value-display {
        font-family: 'Courier New', monospace;
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .metric {
        display: inline-block;
        margin: 10px 15px 10px 0;
        padding: 10px 15px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .metric-label {
        font-size: 12px;
        color: #666;
        display: block;
        margin-bottom: 5px;
      }
      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #632ca6;
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }
      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group input:focus {
        outline: none;
        border-color: #632ca6;
      }
      button.primary {
        background: #632ca6;
        font-size: 16px;
        padding: 12px 24px;
      }
      button.primary:hover {
        background: #4a1f7a;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üêõ Live Debugger Test</h1>

      <div class="section">
        <h2>Configuration</h2>
        <form id="config-form" onsubmit="event.preventDefault(); startLiveDebugger()">
          <div class="form-group">
            <label for="service-input">Service:</label>
            <input
              type="text"
              id="service-input"
              value="my-service"
              placeholder="Enter service name"
              required
            />
          </div>
          <div class="form-group">
            <label for="env-input">Environment:</label>
            <input
              type="text"
              id="env-input"
              value="dev"
              placeholder="Enter environment name"
              required
            />
          </div>
          <div class="form-group">
            <button type="submit" class="primary" id="start-button">Start Live Debugger</button>
          </div>
        </form>
        <div id="config-display" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
          <strong>RC Proxy URL:</strong> <span id="proxy-url">http://localhost:3030</span><br />
          <strong>Service:</strong> <span id="service-value">-</span><br />
          <strong>Environment:</strong> <span id="env-value">-</span><br />
          <strong>Version:</strong> <span id="version-value">-</span>
        </div>
        <p id="auto-trigger-note" style="display: none; margin-top: 10px; font-size: 14px; color: #666;">
          Instrumented functions in <code>probes-go-here.js</code> are automatically triggered every second.
        </p>
      </div>

      <div class="section">
        <h2>Status</h2>
        <div id="status-display" class="status info">Ready - Configure and click "Start Live Debugger" to begin</div>
        <div>
          <div class="metric">
            <span class="metric-label">Active Probes</span>
            <span class="metric-value" id="probe-count">0</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>RC Proxy Health</h2>
        <button onclick="checkProxyHealth()">Check Proxy Health</button>
        <div class="value-display" id="health-display">Click button to check proxy health</div>
      </div>

      <div class="section">
        <h2>Current Probes</h2>
        <button onclick="refreshProbes()">Refresh Probes</button>
        <div class="value-display" id="probes-display">No probes loaded yet</div>
      </div>

      <div class="section">
        <h2>Console Log</h2>
        <button onclick="clearConsole()">Clear Console</button>
        <div class="value-display" id="console-log"></div>
      </div>
    </div>

    <!-- Datadog SDKs (using local dev server) -->
    <script src="http://localhost:8080/datadog-logs.js"></script>
    <script src="http://localhost:8080/datadog-live-debugger.js"></script>

    <!-- Load test functions -->
    <script src="probes-go-here.js"></script>

    <script>
      let isInitialized = false
      const RC_PROXY_URL = 'http://localhost:3030'

      // Function to check if RC proxy is running
      async function checkRCProxyAvailability() {
        try {
          const controller = new AbortController()
          const timeoutId = setTimeout(() => controller.abort(), 3000) // 3 second timeout

          const response = await fetch(`${RC_PROXY_URL}/health`, {
            signal: controller.signal
          })
          clearTimeout(timeoutId)

          if (!response.ok) {
            return { available: false, error: `RC proxy returned status ${response.status}` }
          }

          return { available: true }
        } catch (err) {
          if (err.name === 'AbortError') {
            return { available: false, error: 'Connection timeout - proxy not responding' }
          }
          return { available: false, error: err.message }
        }
      }

      // Function to start Live Debugger with user-provided config
      async function startLiveDebugger() {
        if (isInitialized) {
          updateStatus('Live Debugger already initialized', 'warning')
          return
        }

        // Get values from form
        const service = document.getElementById('service-input').value.trim()
        const env = document.getElementById('env-input').value.trim()
        const version = `1.0.0-${crypto.randomUUID().slice(0, 8)}`

        if (!service || !env) {
          updateStatus('Please provide both service and environment', 'warning')
          return
        }

        // Disable form and show checking status
        document.getElementById('start-button').disabled = true
        document.getElementById('service-input').disabled = true
        document.getElementById('env-input').disabled = true
        updateStatus('Checking RC proxy availability...', 'info')
        logToConsole('üîç Checking if RC proxy is running...')

        // Check if RC proxy is available
        const proxyCheck = await checkRCProxyAvailability()

        if (!proxyCheck.available) {
          const errorMsg = `RC Proxy not available at ${RC_PROXY_URL}`
          const detailedMsg = `${errorMsg}\n\nError: ${proxyCheck.error}\n\nPlease make sure the RC proxy is running before starting the Live Debugger.\nYou can start it with: cd sandbox/rc-proxy && node server.js`

          updateStatus(errorMsg, 'warning')
          logToConsole(`‚ùå ${errorMsg}`)
          logToConsole(`   Error: ${proxyCheck.error}`)
          logToConsole('   üí° Start the proxy with: cd sandbox/rc-proxy && node server.js')

          alert(detailedMsg)

          // Re-enable form
          document.getElementById('start-button').disabled = false
          document.getElementById('service-input').disabled = false
          document.getElementById('env-input').disabled = false
          return
        }

        logToConsole('‚úÖ RC proxy is running and healthy')

        // Update config display
        document.getElementById('service-value').textContent = service
        document.getElementById('env-value').textContent = env
        document.getElementById('version-value').textContent = version
        document.getElementById('config-display').style.display = 'block'
        document.getElementById('auto-trigger-note').style.display = 'block'

        // Initialize Datadog Logs SDK
        if (window.DD_LOGS) {
          window.DD_LOGS.init({
            clientToken: 'pubaf1e9488f1ff409b1454108915265ecb',
            site: 'datad0g.com',
            service,
            env,
            source: 'dd_debugger',
            forwardErrorsToLogs: true,
            sessionSampleRate: 100,
          })
          console.log('Datadog Logs SDK initialized')
          logToConsole('‚úÖ Datadog Logs SDK initialized')
        } else {
          console.error('Datadog Logs SDK not available')
          logToConsole('‚ùå Datadog Logs SDK not available')
        }

        // Initialize the Live Debugger SDK with RC proxy
        try {
          window.DD_LIVE_DEBUGGER.init({
            service,
            env,
            version,
            remoteConfigProxyUrl: RC_PROXY_URL
          })

          logToConsole('‚úÖ Live Debugger initialized with RC proxy')
          updateStatus('Live Debugger initialized - polling RC proxy every 5s', 'success')
          isInitialized = true

          // Start auto-refresh after initialization
          startAutoRefresh()
        } catch (err) {
          logToConsole('‚ùå Failed to initialize: ' + err.message, 'error')
          updateStatus('Failed to initialize: ' + err.message, 'warning')

          // Re-enable form on error
          document.getElementById('start-button').disabled = false
          document.getElementById('service-input').disabled = false
          document.getElementById('env-input').disabled = false
        }
      }

      // Helper functions
      function updateStatus(message, type = 'info') {
        const statusEl = document.getElementById('status-display')
        statusEl.textContent = message
        statusEl.className = 'status ' + type
      }

      function logToConsole(message) {
        const consoleEl = document.getElementById('console-log')
        const timestamp = new Date().toLocaleTimeString()
        consoleEl.textContent += `[${timestamp}] ${message}\n`
        consoleEl.scrollTop = consoleEl.scrollHeight
      }

      function clearConsole() {
        document.getElementById('console-log').textContent = ''
      }

      // Check RC proxy health
      async function checkProxyHealth() {
        try {
          const response = await fetch('http://localhost:3030/health')
          const health = await response.json()
          document.getElementById('health-display').textContent = JSON.stringify(health, null, 2)
          logToConsole('‚úÖ Proxy health check successful')
        } catch (err) {
          document.getElementById('health-display').textContent = 'Error: ' + err.message
          logToConsole('‚ùå Proxy health check failed: ' + err.message)
        }
      }

      // Refresh probes display from SDK
      function refreshProbes() {
        try {
          const probes = window.DD_LIVE_DEBUGGER.getProbes()

          document.getElementById('probe-count').textContent = probes.length
          document.getElementById('probes-display').textContent = JSON.stringify(probes, null, 2)

          logToConsole(`‚úÖ SDK has ${probes.length} active probe(s)`)
        } catch (err) {
          document.getElementById('probes-display').textContent = 'Error: ' + err.message
          logToConsole('‚ùå Failed to get probes from SDK: ' + err.message)
        }
      }

      // Auto-refresh display every 10 seconds from SDK (only after initialization)
      function startAutoRefresh() {
        setInterval(() => {
          refreshProbes()
          checkProxyHealth()
        }, 10000)

        // Initial load
        setTimeout(() => {
          refreshProbes()
          checkProxyHealth()
        }, 1000)
      }
    </script>
  </body>
</html>
